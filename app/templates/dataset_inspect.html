{% extends "dataset_layout.html" %}

{% block page_title %}
Data &quot;<span class="dataset_meta">{{ dataset.get_name() }}</span>&quot;
{% endblock %}

{% block pagebody %}

<div class="row df_inspect_overview">
    <div class="accordion col-12" id="df_overview_collapse">
        <div class="card">
            <div class="card-header slim-card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#df_overview_collapse_a"> 
                        <i class="fas fa-angle-down"></i> Overview
                    </button>
                </h5>
            </div>

            <div id="df_overview_collapse_a" class="collapse hide" data-parent="#df_overview_collapse">
                <div class="card-body">

                    <div id="overview-chart-holder" style="">
                        <canvas id="overview-chart" style="position: relative; height: 40vh; width: 80vw;"></canvas>
                    </div>
                    <div class="overview-chart-controls">
                    <span>Annotators: </span>
                    <div class="btn-group">
                        <button id="show_all_annotators" class="btn btn-light">All</button>
                        <button id="show_individual_annotators" class="btn btn-light">Individual</button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row dataset_inspect_metadata">
    <div class="dataset_inspect_meta col-6">
        <span class="dataset_inspect_meta_label">Owner:</span> <span class="dataset_inspect_meta_value">{{ dataset.owner.get_name() }}</span><br />
        <span class="dataset_inspect_meta_label">Fields:</span> <span class="dataset_inspect_meta_value">{{ ", ".join(df.columns) }}</span><br />
        <span class="dataset_inspect_meta_label">Access Roles:</span> <span class="dataset_inspect_meta_value">{{ user_roles|join(", ") }}</span>
    </div>
    <div class="dataset_inspect_meta col-6">
        <form action="{{ url_for("inspect_dataset", dsid=dataset.dataset_id) }}" method="get" id="form_doquery">
        <div class="form-group row">
            <div class="col-12">
                <div class="input-group">
                    <input id="query" name="query" placeholder="search" type="text" class="form-control" value="{{ query }}"> 
                    <div class="input-group-append">
                        <button class="btn btn-outline-primary input-group-text" onclick="return $('#form_doquery').submit();">
                            <i class="fa fa-arrow-circle-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div> 

        <div class="form-group row">
            <div class="col-12">
                <div class="custom-control custom-checkbox custom-control-inline">
                    {% if hideempty %}
                    <input name="hideempty" id="hideempty" type="hidden" value="true" />
                    <input name="cb_hideempty" id="cb_hideempty" type="checkbox" class="custom-control-input" value="true" checked="checked"> 
                    {% else %}
                    <input name="hideempty" id="hideempty" type="hidden" value="false" />
                    <input name="cb_hideempty" id="cb_hideempty" type="checkbox" class="custom-control-input" value="false"> 
                    {% endif %}
                    <label for="cb_hideempty" class="custom-control-label">Hide rows without annotations</label>
                </div>
            </div>
        </div> 
        </form>

    </div>
</div>

<div class="row df_pagination">
    <div class="col-12">
        Results: {{results}}<br />
    <div class="btn-group">
        {% set addclass="" %}
        {% if page == 1 %}{% set addclass="active" %}{% endif %}

        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, hideempty=hideempty, page=1) }}"><i class="fa fa-angle-double-left"> </i></a>
        {% if not 1 in pagination_elements and pages > 0 %}
        <a class="btn btn-sm btn-outline-secondary" disabled href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, hideempty=hideempty, page=1) }}"><i class="fas fa-ellipsis-h"></i> </a>
        {% endif %}

        {% for pagination_page in pagination_elements %}

        {% set addclass="" %}
        {% if page == pagination_page %}{% set addclass="active" %}{% endif %}
        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, hideempty=hideempty, page=pagination_page) }}">{{ pagination_page }}</a>

        {% endfor %}

        {% if not pages in pagination_elements and pages > 0 %}
        <a class="btn btn-sm btn-outline-secondary" disabled href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, hideempty=hideempty, page=1) }}"><i class="fas fa-ellipsis-h"></i> </a>
        {% endif %}

        {% set addclass="" %}
        {% if page == pages %}{% set addclass="active" %}{% endif %}
        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, hideempty=hideempty, page=pages) }}"><i class="fa fa-angle-double-right"> </i></a>
    </div>

    </div>
</div>
<div class="row">
    {{ macros.render_dataframe(df, "dfid", "dfclasses", query=query, maxrows=page_size) }}
</div>

{% endblock %}

{% block addscript %}
<script>
    const ACTIVE_DATASET_ID = {{ dataset.dataset_id }};

    window.chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        grey: 'rgb(201, 203, 207)'
    };

    function initOverviewChart(target) {
        const ctx = document.getElementById(target);
        const config = {
            type: 'doughnut',
            data: {
                datasets: [],
                labels: []
            },
            options: {
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            const datasetLabel = data.datasets[tooltipItem.datasetIndex].label || '';
                            const lbl = data.labels[tooltipItem.index];
                            const value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index] || 0;
                            return datasetLabel + ': ' + lbl + " " + value;
                        }
                    }
                },
                responsive: true,
                legend: {
                    position: "top",
                },
                animation: {
					animateScale: true,
					animateRotate: true
				},
                title: {
                    display: true,
                    text: "Annotations"
                },
                circumference: Math.PI,
                rotation: -Math.PI
            }
        };

        const overviewChart = new Chart(ctx, config);

        fetch(window.OMEN_BASE + "dataset/" + ACTIVE_DATASET_ID + "/overview.json")
          .then(response => response.json())
          .then(overviewData => updateOverviewChart(overviewChart, overviewData, config));

        return overviewChart;
    }

    const overviewChart = initOverviewChart("overview-chart");
    let overviewDataCache = null;
    let overviewChartConfig = null;

    document.getElementById("show_all_annotators").addEventListener("click", () => {
        updateOverviewChart(overviewChart, overviewDataCache, overviewChartConfig, "all");
    });
    document.getElementById("show_individual_annotators").addEventListener("click", () => {
        updateOverviewChart(overviewChart, overviewDataCache, overviewChartConfig, "single");
    });

    function updateOverviewChart(overviewChart, overviewData, config, mode)  {
        if (!overviewData) { 
            return;
        }
        overviewDataCache = overviewData;
        overviewChartConfig = config;
       
        // mode = mode || 'all';
        mode = mode || 'single';
        config.data.labels = [...overviewData.tags];

        if (mode === 'single') {
            // config.data.labels.push("N/A");
        }
            
        overviewChart.data.datasets = [];
        overviewChart.options.title.text = "Annotations";

        if (mode === 'all') {
            const allAnnosDS = {data: [], backgroundColor: []};
            const default_colors = [...Object.keys(window.chartColors)];
            config.data.labels.forEach((tag) => {
                const tag_count = overviewData.all_annotations[tag] || 0;
                const tag_meta = overviewData.tag_metadata[tag] || {}

                let tag_color = null;
                if (tag_meta.color && window.chartColors[tag_meta]) {
                    tag_color = window.chartColors[tag_meta];
                }
                    
                if (!tag_color) { 
                    tag_color = default_colors.pop();
                } else {
                    default_colors.remove(tag_color);
                }

                allAnnosDS.data.push(tag_count);
                allAnnosDS.backgroundColor.push(tag_color);
            });
            allAnnosDS.label = "All Annotations";
            overviewChart.data.datasets.push(allAnnosDS);
        } else {
            overviewChart.data.datasets = [];
            for (const [annotator, annotations] of Object.entries(overviewData.annotations)) {
                const annoDS = {data: [], backgroundColor: []};
                const default_colors = [...Object.keys(window.chartColors)];
                config.data.labels.forEach((tag) => {
                    const tag_count = annotations[tag] || 0;
                    const tag_meta = overviewData.tag_metadata[tag] || {}

                    let tag_color = null;
                    if (tag_meta.color && window.chartColors[tag_meta]) {
                        tag_color = window.chartColors[tag_meta];
                    }
                        
                    if (!tag_color) { 
                        tag_color = default_colors.pop();
                    } else {
                        default_colors.remove(tag_color);
                    }

                    annoDS.data.push(tag_count);
                    annoDS.backgroundColor.push(tag_color);
                });
                
                annoDS.label = annotator; 
                console.log(annoDS);
                overviewChart.data.datasets.push(annoDS);
            }
        }
        
        overviewChart.update();
    }

    /**
    * https://stackoverflow.com/questions/1090948/change-url-parameters
     * http://stackoverflow.com/a/10997390/11236
     */
    function updateURLParameter(url, param, paramVal) {
        let TheAnchor = null;
        let newAdditionalURL = "";
        let tempArray = url.split("?");
        let baseURL = tempArray[0];
        let additionalURL = tempArray[1];
        let temp = "";

        if (additionalURL) 
        {
            let tmpAnchor = additionalURL.split("#");
            let TheParams = tmpAnchor[0];
            TheAnchor = tmpAnchor[1];
            if(TheAnchor)
                additionalURL = TheParams;

            tempArray = additionalURL.split("&");

            for (let i=0; i<tempArray.length; i++)
            {
                if(tempArray[i].split('=')[0] != param)
                {
                    newAdditionalURL += temp + tempArray[i];
                    temp = "&";
                }
            }        
        }
        else
        {
            let tmpAnchor = baseURL.split("#");
            let TheParams = tmpAnchor[0];
            TheAnchor  = tmpAnchor[1];

            if(TheParams)
                baseURL = TheParams;
        }

        if(TheAnchor)
            paramVal += "#" + TheAnchor;

        let rows_txt = temp + "" + param + "=" + paramVal;
        return baseURL + "?" + newAdditionalURL + rows_txt;
    }

        const hideEmptyCB = document.getElementById("cb_hideempty");
        hideEmptyCB.addEventListener("click", function() {
            document.getElementById("hideempty").value = hideEmptyCB.checked;
            return $('#form_doquery').submit();
        });
    </script>
{% endblock %}
