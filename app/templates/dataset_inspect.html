{% extends "dataset_layout.html" %}

{% block page_title %}
Data &quot;<span class="dataset_meta">{{ dataset.get_name() }}</span>&quot;
{% endblock %}

{% block pagebody %}

<div class="row df_inspect_overview">
    <div class="accordion col-12" id="df_overview_collapse">

        <div class="card">
            <div class="card-header slim-card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#df_overview_collapse_b"> 
                        <i class="fas fa-angle-down"></i> Metadata
                    </button>
                </h5>
            </div>

            <div id="df_overview_collapse_b" class="collapse hide" data-parent="#df_overview_collapse">
                <div class="card-body">
    
                    <div class="dataset_inspect_meta">
                        <span class="dataset_inspect_meta_label">Owner:</span> <span class="dataset_inspect_meta_value">{{ dataset.owner.get_name() }}</span><br />
                        <span class="dataset_inspect_meta_label">Fields:</span> <span class="dataset_inspect_meta_value">{{ ", ".join(df.columns) }}</span><br />
                        <span class="dataset_inspect_meta_label">Access Roles:</span> <span class="dataset_inspect_meta_value">{{ user_roles|join(", ") }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header slim-card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#df_overview_collapse_a"> 
                        <i class="fas fa-angle-down"></i> Annotation Overview
                    </button>
                </h5>
            </div>

            <div id="df_overview_collapse_a" class="collapse hide" data-parent="#df_overview_collapse">
                <div class="card-body">

                    <div id="overview-chart-holder" style="">
                        <canvas id="overview-chart" style="position: relative; height: 40vh; width: 80vw;"></canvas>
                    </div>
                    <div class="overview-chart-controls">
                    <span>Annotators: </span>
                    <div class="btn-group">
                        <button id="show_all_annotators" class="btn btn-light">All</button>
                        <button id="show_individual_annotators" class="btn btn-light">Individual</button>
                    </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="row df_pagination">
    <div class="col-sm-12 col-md-7">
        Entries: {{results}}<br />
    <div class="btn-group">
        {% set addclass="" %}
        {% if page == 1 %}{% set addclass="active" %}{% endif %}

        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=1) }}"><i class="fa fa-angle-double-left"> </i></a>
        {% if not 1 in pagination_elements and pages > 0 %}
        <a class="btn btn-sm btn-outline-secondary" disabled href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=1) }}"><i class="fas fa-ellipsis-h"></i> </a>
        {% endif %}

        {% for pagination_page in pagination_elements %}

        {% set addclass="" %}
        {% if page == pagination_page %}{% set addclass="active" %}{% endif %}
        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=pagination_page) }}">{{ pagination_page }}</a>

        {% endfor %}

        {% if not pages in pagination_elements and pages > 0 %}
        <a class="btn btn-sm btn-outline-secondary" disabled href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=1) }}"><i class="fas fa-ellipsis-h"></i> </a>
        {% endif %}

        {% set addclass="" %}
        {% if page == pages %}{% set addclass="active" %}{% endif %}
        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=pages) }}"><i class="fa fa-angle-double-right"> </i></a>
    </div>

    </div>

    <div class="col-sm-12 col-md-5">

        <form action="{{ url_for("inspect_dataset", dsid=dataset.dataset_id) }}" method="get" id="form_doquery">
        <div class="form-group row">
            <div class="col-12">
                <div class="input-group">
                    <input id="query" name="query" placeholder="search" type="text" class="form-control" value="{{ query }}"> 
                    <div class="input-group-append">
                        <button class="btn btn-outline-primary input-group-text" onclick="return $('#form_doquery').submit();">
                            <i class="fa fa-arrow-circle-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div> 

        <div class="form-group row">
            <div class="col-12">
                <div class="custom-control custom-checkbox custom-control-inline">
                    {% if restrict_view and restrict_view == 'tagged' %}
                    <input name="restrict_view" id="restrict_view" type="hidden" value="tagged" />
                    <input name="cb_hideempty" id="cb_hideempty" type="checkbox" class="custom-control-input" value="true" checked="checked"> 
                    {% else %}
                    <input name="restrict_view" id="restrict_view" type="hidden" value="" />
                    <input name="cb_hideempty" id="cb_hideempty" type="checkbox" class="custom-control-input" value="false"> 
                    {% endif %}
                    <label for="cb_hideempty" class="custom-control-label">Hide untagged rows</label>
                </div>
            </div>
        </div> 
        </form>
    </div>
</div>
<div class="row">

{% set df_editor_id = "dfid" %}
{% set df_class = "dfclasses" %}
{% set maxrows = page_size %}
{% set hide_nan = True %}

{% if df.shape[0] > 0 %}
<div id="{{df_editor_id}}" class="df_inspect_table alert alert-{% if df_class=='error' %}danger{%else%}{{df_class}}{% endif %}">
    {% set id_column = df.columns[0] %}
    {% set text_column = df.columns[1] %}
    <div class="df_inspect_table_header row">
        <div class="df_inspect_header df_inspect_idcol col-1 d-none d-md-block">{{ id_column }}</div>
        <div class="df_inspect_header df_inspect_textcol col-sm col-md">{{ text_column }}</div>
    </div>
    {% for index, row in df.iterrows() %}
    {% include "dataset_inspect_row.html" with context %}
    {% endfor %}
</div>
{% endif %}

</div>

{% endblock %}

{% block addscript %}
<script>
    const ACTIVE_DATASET_ID = {{ dataset.dataset_id }};

    window.chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        gray: 'rgb(201, 203, 207)',
        grey: 'rgb(201, 203, 207)'
    };

    function initOverviewChart(target) {
        const ctx = document.getElementById(target);
        const config = {
            type: 'doughnut',
            data: {
                datasets: [],
                labels: []
            },
            options: {
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            const datasetLabel = data.datasets[tooltipItem.datasetIndex].label || '';
                            const lbl = data.labels[tooltipItem.index];
                            const value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index] || 0;
                            return datasetLabel + ': ' + lbl + " " + value;
                        }
                    }
                },
                responsive: true,
                legend: {
                    position: "top",
                },
                animation: {
					animateScale: true,
					animateRotate: true
				},
                title: {
                    display: true,
                    text: "Annotations"
                },
                circumference: Math.PI,
                rotation: -Math.PI
            }
        };

        const overviewChart = new Chart(ctx, config);

        fetch(window.OMEN_BASE + "dataset/" + ACTIVE_DATASET_ID + "/overview.json")
          .then(response => response.json())
          .then(overviewData => updateOverviewChart(overviewChart, overviewData, config));

        return overviewChart;
    }

    const overviewChart = initOverviewChart("overview-chart");
    let overviewDataCache = null;
    let overviewChartConfig = null;

    document.getElementById("show_all_annotators").addEventListener("click", () => {
        updateOverviewChart(overviewChart, overviewDataCache, overviewChartConfig, "all");
    });
    document.getElementById("show_individual_annotators").addEventListener("click", () => {
        updateOverviewChart(overviewChart, overviewDataCache, overviewChartConfig, "single");
    });

    function updateOverviewChart(overviewChart, overviewData, config, mode)  {
        if (!overviewData) { 
            return;
        }
        overviewDataCache = overviewData;
        overviewChartConfig = config;
       
        // mode = mode || 'all';
        mode = mode || 'single';
        config.data.labels = [...overviewData.tags];

        if (mode === 'single') {
            // config.data.labels.push("N/A");
        }
            
        overviewChart.data.datasets = [];
        overviewChart.options.title.text = "Annotations";

        if (mode === 'all') {
            const allAnnosDS = {data: [], backgroundColor: []};
            const default_colors = [...Object.keys(window.chartColors)];
            default_colors.splice(default_colors.indexOf("gray"), 1)
            config.data.labels.forEach((tag) => {
                const tag_count = overviewData.all_annotations[tag] || 0;
                const tag_meta = overviewData.tag_metadata[tag] || {}

                let tag_color = null;
                if (tag_meta.color && window.chartColors[tag_meta.color]) {
                    tag_color = window.chartColors[tag_meta.color];
                }
                    
                if (!tag_color) {
                    tag_color = default_colors.shift();
                } else {
                    if (default_colors.indexOf(tag_color) > -1) {
                        default_colors.splice(default_colors.indexOf(tag_color), 1);
                    }
                }

                allAnnosDS.data.push(tag_count);
                allAnnosDS.backgroundColor.push(tag_color);
            });
            allAnnosDS.label = "All Annotations";
            overviewChart.data.datasets.push(allAnnosDS);
        } else {
            overviewChart.data.datasets = [];
            for (const [annotator, annotations] of Object.entries(overviewData.annotations)) {
                const annoDS = {data: [], backgroundColor: []};
                const default_colors = [...Object.keys(window.chartColors)];
                default_colors.splice(default_colors.indexOf("gray"), 1)
                config.data.labels.forEach((tag) => {
                    const tag_count = annotations[tag] || 0;
                    const tag_meta = overviewData.tag_metadata[tag] || {}

                    let tag_color = null;
                    if (tag_meta.color && window.chartColors[tag_meta.color]) {
                        tag_color = window.chartColors[tag_meta.color];
                    }
                    
                    console.log(tag_color, default_colors)
                    if (!tag_color) { 
                        tag_color = default_colors.shift();
                    } else {
                        if (default_colors.indexOf(tag_color) > -1) {
                            default_colors.splice(default_colors.indexOf(tag_color), 1);
                        }
                    }

                    annoDS.data.push(tag_count);
                    annoDS.backgroundColor.push(tag_color);
                });
                
                annoDS.label = annotator; 
                console.log(annoDS);
                overviewChart.data.datasets.push(annoDS);
            }
        }
        
        overviewChart.update();
    }

    /**
    * https://stackoverflow.com/questions/1090948/change-url-parameters
     * http://stackoverflow.com/a/10997390/11236
     */
    function updateURLParameter(url, param, paramVal) {
        let TheAnchor = null;
        let newAdditionalURL = "";
        let tempArray = url.split("?");
        let baseURL = tempArray[0];
        let additionalURL = tempArray[1];
        let temp = "";

        if (additionalURL) 
        {
            let tmpAnchor = additionalURL.split("#");
            let TheParams = tmpAnchor[0];
            TheAnchor = tmpAnchor[1];
            if(TheAnchor)
                additionalURL = TheParams;

            tempArray = additionalURL.split("&");

            for (let i=0; i<tempArray.length; i++)
            {
                if(tempArray[i].split('=')[0] != param)
                {
                    newAdditionalURL += temp + tempArray[i];
                    temp = "&";
                }
            }        
        }
        else
        {
            let tmpAnchor = baseURL.split("#");
            let TheParams = tmpAnchor[0];
            TheAnchor  = tmpAnchor[1];

            if(TheParams)
                baseURL = TheParams;
        }

        if(TheAnchor)
            paramVal += "#" + TheAnchor;

        let rows_txt = temp + "" + param + "=" + paramVal;
        return baseURL + "?" + newAdditionalURL + rows_txt;
    }

    const hideEmptyCB = document.getElementById("cb_hideempty");
    hideEmptyCB.addEventListener("click", function() {
        document.getElementById("restrict_view").value = hideEmptyCB.checked ? 'tagged' : "";
        return $('#form_doquery').submit();
    });


function initEditorButton(btn) {
    btn.addEventListener("click", function(evt) {
        const evt_tag = btn.dataset.tag;
        const evt_sample = btn.dataset.sample;
        evt.preventDefault();
        console.log("set-sample", evt_sample, evt_tag);
        const btn_row = btn.closest(".df_inspect_table_row");
        btn_row.style.opacity = 0.5;
        console.log(btn_row);
        console.log(window.location.href);

        const target_uri = window.location.href;
        const req_data = {
            "single_row": evt_sample,
            "set_tag": evt_tag
        }

        fetch(target_uri, {
            method: 'post',
            body: JSON.stringify(req_data)
        }).then(response => {
            return response.text()
        }).then(response => {
            console.log("response", response);
            btn_row.outerHTML = response;

            // make sure events for the new row are bound

            document.querySelectorAll("a.df_inspect_changeaction").forEach(btn => {
                if (evt_sample == btn.dataset.sample) {
                    initEditorButton(btn);
                }
            });
        });

        return false;
    });
}

     function initEditorButtons() {
         document.querySelectorAll("a.df_inspect_changeaction").forEach(initEditorButton);
     }

    initEditorButtons();


    </script>
{% endblock %}
