{% extends "dataset_layout.html" %}

{% block page_title %}
Data &quot;<span class="dataset_meta">{{ dataset.get_name() }}</span>&quot;
{% endblock %}

{% block pagebody %}

<div class="row df_inspect_overview">
    <div class="accordion col-12" id="df_overview_collapse">

        <div class="card">
            <div class="card-header slim-card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#df_overview_collapse_b"> 
                        <i class="fas fa-angle-down"></i> Metadata
                    </button>
                </h5>
            </div>

            <div id="df_overview_collapse_b" class="collapse hide" data-parent="#df_overview_collapse">
                <div class="card-body">
    
                    <div class="dataset_inspect_meta">
                        <span class="dataset_inspect_meta_label">Owner:</span> <span class="dataset_inspect_meta_value">{{ dataset.owner.get_name() }}</span><br />
                        <span class="dataset_inspect_meta_label">Fields:</span> <span class="dataset_inspect_meta_value">{{ ", ".join(df.columns) }}</span><br />
                        <span class="dataset_inspect_meta_label">Access Roles:</span> <span class="dataset_inspect_meta_value">{{ user_roles|join(", ") }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header slim-card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#df_overview_collapse_a"> 
                        <i class="fas fa-angle-down"></i> Annotation Overview
                    </button>
                </h5>
            </div>

            <div id="df_overview_collapse_a" class="collapse hide" data-parent="#df_overview_collapse">
                <div class="card-body">

                    <div class="row">
                        <div id="overview-chart-holder row" class="col-12 col-md-6" style="">
                            <canvas id="overview-chart" style="position: relative; height: 40vh;"></canvas>
                        </div>
                        <div class="df_inspect_analysis_meta col-12 col-md-6">
                            <p>
                            <strong>Fleiss' Kappa:</strong> <span id="anno_fleiss_value">unavailable</span> <span id="anno_fleiss_text"></span> <br />
                            </p>
                            <p class="df_inspect_note">
                            Note that inter-annotator agreement only takes into account samples with annotations by at least 2 different users.
                            </p>
                        </div>
                    </div>
                    <div class="overview-chart-controls">
                    <span>Annotators: </span>
                    <div class="btn-group">
                        <button id="show_all_annotators" class="btn btn-light">All</button>
                        <button id="show_individual_annotators" class="btn btn-light">Individual</button>
                    </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<form action="{{ url_for("inspect_dataset", dsid=dataset.dataset_id) }}" method="get" id="form_doquery">

<div class="row df_pagination">
    <div class="col-sm-12 col-md-7">
        Entries: {{results}}<br />
    <div class="btn-group">
        {% set addclass="" %}
        {% if page == 1 %}{% set addclass="active" %}{% endif %}

        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=1) }}"><i class="fa fa-angle-double-left"> </i></a>
        {% if not 1 in pagination_elements and pages > 0 %}
        <a class="btn btn-sm btn-outline-secondary" disabled href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=1) }}"><i class="fas fa-ellipsis-h"></i> </a>
        {% endif %}

        {% for pagination_page in pagination_elements %}

        {% set addclass="" %}
        {% if page == pagination_page %}{% set addclass="active" %}{% endif %}
        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=pagination_page) }}">{{ pagination_page }}</a>

        {% endfor %}

        {% if not pages in pagination_elements and pages > 0 %}
        <a class="btn btn-sm btn-outline-secondary" disabled href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=1) }}"><i class="fas fa-ellipsis-h"></i> </a>
        {% endif %}

        {% set addclass="" %}
        {% if page == pages %}{% set addclass="active" %}{% endif %}
        <a class="btn btn-sm btn-outline-primary {{addclass}}" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id, query=query, restrict_view=restrict_view, page=pages) }}"><i class="fa fa-angle-double-right"> </i></a>
    </div>

    </div>

    <div class="col-sm-12 col-md-5">
        <div class="form-group row">
            <div class="col-12">
                <div class="input-group">
                    <input id="query" name="query" placeholder="search" type="text" class="form-control" value="{{ query }}"> 
                    <div class="input-group-append">
                        <button class="btn btn-outline-primary input-group-text" onclick="return $('#form_doquery').submit();">
                            <i class="fa fa-arrow-circle-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div> 

        <div class="form-group row">
            <div class="col-12 d-flex" style="justify-content: end">
                <div class="custom-control custom-checkbox custom-control-inline">
                    {% if restrict_view and restrict_view == 'tagged' %}
                    <input name="restrict_view" id="restrict_view" type="hidden" value="tagged" />
                    <input name="cb_hideempty" id="cb_hideempty" type="checkbox" class="custom-control-input" value="true" checked="checked"> 
                    {% else %}
                    <input name="restrict_view" id="restrict_view" type="hidden" value="" />
                    <input name="cb_hideempty" id="cb_hideempty" type="checkbox" class="custom-control-input" value="false"> 
                    {% endif %}
                    <label for="cb_hideempty" class="custom-control-label">Hide untagged rows</label>
                </div>
            </div>
        </div> 
    </div>
</div>
<div class="row df_pagination">
    {% set taglist = dataset.get_taglist() %}
    <input type="hidden" name="restrict_taglist_include" id="restrict_taglist_include" value="" />
    <input type="hidden" name="restrict_taglist_exclude" id="restrict_taglist_exclude" value="" />

    {% if taglist|length <= 2 %}
        <div class="col-12 col-md-6 offset-md-6 d-none d-md-flex df_inspect_tagselect">
    {% else %}
        <div class="col-12 d-none d-md-flex df_inspect_tagselect">
    {% endif %}
            {% for tag in taglist %}
            <div class="custom-control custom-checkbox custom-control-inline">
                <input name="cb_show_tag" autocomplete="off" id="cb_show_tag_{{loop.index}}" type="checkbox" class="custom-control-input cb_show_tag_elem" value="{{ tag }}" data-tristate="{{ tagstates[tag] or 0 }}" data-tag="{{ tag }}"> 
                <label for="cb_show_tag_{{loop.index}}" class="custom-control-label">show {{ tag }}</label>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

</form>

<div class="row">
    {% set df_editor_id = "dfid" %}
    {% set df_class = "dfclasses" %}
    {% set maxrows = page_size %}
    {% set hide_nan = True %}

    {% if df.shape[0] > 0 %}
    <div id="{{df_editor_id}}" class="df_inspect_table col-12 alert alert-{% if df_class=='error' %}danger{%else%}{{df_class}}{% endif %}">
        {% set id_column = dataset.get_id_column() %}
        {% set text_column = dataset.get_text_column() %}
        <div class="df_inspect_table_header row col-12">
            <!--div class="df_inspect_header df_inspect_idcol d-none d-md-flex">{{ id_column }}</div-->
            <div class="df_inspect_header df_inspect_textcol col-sm col-md d-flex">{{ text_column }}</div>
        </div>
        {% for index, row in df.iterrows() %}
        {% include "dataset_inspect_row.html" with context %}
        {% endfor %}
    </div>
    {% endif %}
</div>

{% endblock %}

{% block addscript %}
    <script>
    const ACTIVE_DATASET_ID = {{ dataset.dataset_id }};
    </script>
<script src="{{ url_for("static", filename="inspect.js") }}"></script>
{% endblock %}
