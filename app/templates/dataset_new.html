{% extends "dataset_layout.html" %}

{% block page_title %}
{% if editmode == 'create' %}Create Dataset{% else %}Edit Dataset{% endif %}
{% endblock %}

{% block pagebody %}
<div class="row">
    {% if dataset and ds_errors %}
    <div class="row">
        <h5 class="dfissues col-12">Open issues with this dataset:</h5>
    </div>
    <div class="row">
        <ul class="dfissues">
    {% for errmsg in ds_errors %}
    <li class="badge badge-warning">{{ errmsg }}</li>
    {% else %}
    <li class="badge badge-info">All checks passing.</li>
    {% endfor %}
    </ul>
    </div>
    {% endif %}
</div>

<div class="row" id="dataset_name_change">
    <form method="post" id="form_change_name" enctype="multipart/form-data" class="col-12">
        <div class="input-group col-12">
            <input type="hidden" name="action" value="change_name" />

    {% if dataset and ds_errors and 'unnamed dataset' in ds_errors %}
            <div class="col-12 col-md-2 dsnamecol ds_field_error">Dataset name:</div>
    {% else %}
            <div class="col-12 col-md-2 dsnamecol">Dataset name:</div>
    {% endif %}
            <div class="custom-file col-12 col-md-10">
                <input type="text" placeholder="dataset name" class="custom-input" value="{{ dataset.dsmetadata.name }}" id="dataset_name" name="dataset_name" required="required">
            </div>
            <div class="input-group-append">
                <button class="btn btn-outline-primary input-group-text" id="inputGroupFileAddon02" onclick="return $('#form_change_name').submit();">
                    <i class="fas fa-file"></i>&nbsp;OK
                </button>
            </div>
        </div>
    </form>
</div>

<div class="row">
    <h3 class="col-12">Import New Samples</h3>
</div>

<div class="row" id="dataset_content">
    <form method="post" id="form_upload_file" enctype="multipart/form-data" class="col-12">
        <div class="input-group col-12">
            <input type="hidden" name="action" value="upload_file" />
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="upload_file" name="upload_file" required="required">
                <label class="custom-file-label" for="upload_file">Choose file</label>
            </div>
            <div class="input-group-append">
                <button class="btn btn-outline-primary input-group-text" id="form_upload_file_submit" onclick="return $('#form_upload_file').submit();">
                    <i class="fas fa-file-upload"></i>&nbsp;
                    {% if can_import %}
                    Replace
                    {% elif dataset and dataset.has_content() %}
                    Add
                    {% else %}
                    Upload
                    {% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

{% if has_upload_content %}
    <div class="row upload_meta">
        <div class="col-12">
            <span class="dsmeta">Original filename:</span> <span class="dsmetaval">{{ dataset.dsmetadata.upload_filename }}</span></div>
        <div class="col-12">
            <span class="dsmeta">MIME type:</span> <span class="dsmetaval">{{ dataset.dsmetadata.upload_mimetype }}</span><br />
        </div>
    </div>

    <div class="row upload_meta">
        <div class="col-12 col-md-3" style="margin-top: 0.7em;">Delimiter:</div>
        <form class="dropdown col-3" method="post">
            <input type="hidden" name="action" value="change_delimiter" />
            {% set ds_sep = dataset.dsmetadata.sep or ',' %}
            <a class="btn btn-primary dropdown-toggle dataset_edit_action" role="button" data-toggle="dropdown">
                {% if ds_sep == "\t" %}tab{% else %}{{ ds_sep }}{% endif %}
            </a>

            <div class="dropdown-menu">
                <input type="submit" name="comma" class="dropdown-item dataset_edit_action_value" data-action="change_delimiter" value="," />
                <input type="submit" name="tab" class="dropdown-item dataset_edit_action_value" data-action="change_delimiter" value="\t" />
                <input type="submit" name="semicolon" class="dropdown-item dataset_edit_action_value" data-action="change_delimiter" value=";" />
            </div>
        </form>
    </div>

    <div class="row upload_meta">
        <div class="col-12 col-md-3" style="margin-top: 0.7em;">Quote char:</div>
        <form class="dropdown col-3" method="post">
            <input type="hidden" name="action" value="change_quotechar" />

            {% set ds_quotechar = dataset.dsmetadata.quotechar or '"' %}
            <a class="btn btn-primary dropdown-toggle dataset_edit_action" role="button" data-toggle="dropdown">
                {{ ds_quotechar }}
            </a>

            <div class="dropdown-menu">
                <input type="submit" name="double-quote" class="dropdown-item dataset_edit_action_value" data-action="change_quotechar" value="&quot;" />
                <input type="submit" name="single-quote" class="dropdown-item dataset_edit_action_value" data-action="change_quotechar" value="'" />
            </div>
        </form>
    </div>

    {% if not previewdf is none %}
    <div class="row upload_meta">

        <form method="post" class="col-12">
            <input type="hidden" name="action" value="change_idcolumn">

            <div class="row">
                <label for="idcolumn" class="col-12 col-md-3 col-form-label"><div class="{% if not dataset.dsmetadata.idcolumn %}ds_new_field_error alert alert-warning{% endif %}">Select unique sample ID column:</div></label> 
                <div class="col-12 col-md-9">

                    <select class="taskdef_select" id='idcolumn' name='idcolumn' onchange="this.form.submit()">
                        {% if not dataset.dsmetadata.idcolumn or not dataset.dsmetadata.idcolumn in previewdf.columns %}
                        <option selected="true" disabled="disabled">-</option>
                        {% endif %}
                        {% for colname in previewdf.columns %}
                        {% if dataset.dsmetadata.idcolumn == colname %}
                        <option selected='true' value="{{ colname }}">{{ colname }}</option>
                        {% else %}
                        <option value="{{ colname }}">{{ colname }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>

                </div>
            </div> 
        </form>

    </div>

    <div class="row upload_meta">

        <form method="post" class="col-12">
            <input type="hidden" name="action" value="change_textcol">

            <div class="form-group row">
                <label for="textcol" class="col-12 col-md-3 col-form-label"><div class="{% if not dataset.dsmetadata.textcol %}ds_new_field_error alert alert-warning{% endif %}">Select text column:</div></label> 
                <div class="col-12 col-md-9">

                    <select class="taskdef_select" id='textcol' name='textcol' onchange="this.form.submit()">
                        {% if not dataset.dsmetadata.textcol or not dataset.dsmetadata.textcol in previewdf.columns %}
                        <option selected="true" disabled="disabled">-</option>
                        {% endif %}
                        {% for colname in previewdf.columns %}
                        {% if dataset.dsmetadata.textcol == colname %}
                        <option selected='true' value="{{ colname }}">{{ colname }}</option>
                        {% else %}
                        <option value="{{ colname }}">{{ colname }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>

                </div>
            </div> 
        </form>

    </div>

    {% endif %}
{% endif %}

{% if previewdf is none and not previewdf_alerts %}

    <!-- div class="row">
        <div class="col-12">Preview not available.</div>
    </div -->

{% else %}

    {% if previewdf_alerts %}
    <div class="row">
        {% for alertcontent in previewdf_alerts %}
        <div class="alert alert-danger col-10 offset-1">
            {{ alertcontent }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if not previewdf is none %}
    <div class="row" id="dataset_preview">
        <div class="col-12">
            {{ macros.render_dataframe(previewdf, "previewdftable", "dataframe", 20) }}
        </div>
    </div>
    {% endif %}

{% endif %}

{% if can_import %}
<div class="row upload_meta">
    <form method="post" class="offset-md-2 col-md-4 col-sm-12">
        <input type="hidden" name="action" value="do_discard_import">
        <div class="form-group row">
            <div class="col-12">
                <button class="btn btn-danger" id="form_import_discard_submit" onclick="return $('#form_upload_file').submit();">
                    <i class="fas fa-ban"></i>&nbsp;Discard Data
                </button>
            </div>
        </div>
    </form>
    <form method="post" class="col-md-4 col-sm-12">
        <input type="hidden" name="action" value="do_import">
        <div class="form-group row">
            <div class="col-12">
                <button class="btn btn-success" id="form_import_commit_submit" onclick="return $('#form_upload_file').submit();">
                    <i class="fas fa-file-upload"></i>&nbsp;Import Now
                </button>
            </div>
        </div>
    </form>
</div>
{% endif %}

{% if dataset and dataset.has_content() %}

    <h3>Actions</h3>

    <div class="row ds_actions_toolbar">
        <div class="btn-toolbar col-12">
            <div class="btn-group">
                <a class="btn btn-sm btn-primary" href="{{ url_for("download", dsid=dataset.dataset_id) }}"><i class="fas fa-download"></i> Download</a> 
                <a class="btn btn-sm btn-secondary" href="{{ url_for("inspect_dataset", dsid=dataset.dataset_id) }}"><i class="fas fa-table"></i> View</a> 
            </div>

        </div>
    </div>

    <h3>Task Definition</h3>

    <div class="row seprow">

        <form method="post">
            <input type="hidden" name="action" value="change_annoorder">

            <div class="form-group row">
                <label for="annoorder" class="col-12 col-md-3 col-form-label">
                    <div class="">Select annotation order:</div>
                </label> 
                <div class="col-12 col-md-9">

                    <select class="taskdef_select" id='annoorder' name='annoorder' onchange="this.form.submit()">
                        {% if not dataset.dsmetadata.annoorder or dataset.dsmetadata.annoorder == 'sequential' %} 
                        <option selected="true" value="sequential">sequential</option>
                        <option value="random">random</option>
                        {% else %}
                        <option value="sequential">sequential</option>
                        <option selected="true" value="random">random</option>
                        {% endif %}
                    </select>

                </div>
            </div> 
        </form>

    </div>

    <div class="row seprow">
        <form method="post" id="tag_editor_container">
            {% include "tag_editor.html" with context %}
        </form>
    </div>

    <noscript>
    <div class="row seprow">
        <form method="post">
            <input type="hidden" name="action" value="change_taglist" />
            <div class="row">
                <label for="settaglist" class="col-12 col-md-3 col-form-label">
                    <div class="{% if dataset.get_taglist()|length == 0 %}ds_new_field_error alert alert-warning{% endif %}">Define a tag list</div>
                </label> 
                <div class="col-12 col-md-9">
                    <textarea id="settaglist" name="settaglist" cols="40" rows="5" class="form-control" aria-describedby="settaglistHelpBlock" required="required">{% if dataset.get_taglist()|length > 0 %}{{ dataset.get_taglist()|join('\n') }}{% endif %}</textarea> 
                    <span id="settaglistHelpBlock" class="form-text text-muted">separate single entries by newlines</span>
                </div>
            </div> 
            <div class="row">
                <div class="col-12 offset-md-4 col-md-9">
                    <button name="submit" type="submit" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </form>
    </div>
    </noscript>

    <div class="row seprow">
        <form method="post">
            <input type="hidden" name="action" value="change_description" />
            <div class="row">
                <label for="setdescription" class="col-12 col-md-3 col-form-label">
                    <div><strong>Description</strong> or annotation guidelines.<br />
                        This is visible to all users, markdown is supported.</div>
                </label> 
                <div class="col-12 col-md-9">
                    <textarea id="setdescription" name="setdescription" cols="40" rows="5" class="form-control" aria-describedby="setdescriptionHelpBlock" required="required">{% if dataset.dsmetadata.description %}{{ dataset.dsmetadata.description }}{% endif %}</textarea> 
                    <span id="setdescriptionHelpBlock" class="form-text text-muted">separate single entries by newlines</span>
                </div>
            </div> 
            <div class="row">
                <div class="col-12 offset-md-4 col-md-9">
                    <button name="submit" type="submit" class="btn btn-primary">Update Description</button>
                </div>
            </div>
        </form>

    </div>

    <h3>Manage Access</h3>

    <div class="row">
        <div class="col-12 col-md-8">Manage users who are allowed to add annotations for this dataset:</div>
        <div class="col-12 col-md-4"><a href="{{ url_for("createuser") }}" class="btn btn-sm btn-primary">
                <span class="">create new</span> <i class="fa fa-user-plus"></i>
            </a>
            </div>
    </div>
    <div class="row">
        <ul class="col-12 dsacl" id="dsacl">
        {% for userobj in db.userlist(dbsession) %}
            <li class="row">
                
                <i title="{{userobj.uid}}" class="col-1 fas fa-user aclusericon" style="margin-top: 0.5em;"></i>
                    
                &nbsp; <span class="col-4 aclusermail">{{ userobj.get_name() }} ({{userobj.email}})</span>

                <div class="col-6">
                    {% set dsroles = dataset.get_roles(dbsession, userobj) %}
                    {% if userobj.uid == dataset.owner_id %}
                        <span class="acluserowner">owner</span>
                    {% else %}

                    {% if 'annotator' in dsroles and not 'curator' in dsroles %}
                    <a href="#" class="toggleacl btn btn-sm btn-outline-success" data-roleid="annotator" data-userid="{{userobj.uid}}">
                            <span class="">annotator</span>
                            <i class="far fa-check-square"></i>
                        </a>
                    {% else %}
                    <a href="#" class="toggleacl btn btn-sm btn-outline-primary" data-roleid="annotator" data-userid="{{userobj.uid}}">
                            <span class="">make annotator </span>
                            <i class="far fa-square"></i>
                        </a>
                    {% endif %}

                    {% if 'curator' in dsroles %}
                    <a href="#" class="toggleacl btn btn-sm btn-outline-success" data-roleid="curator" data-userid="{{userobj.uid}}">
                            <span class="">curator</span>
                            <i class="far fa-check-square"></i>
                        </a>
                    {% else %}
                    <a href="#" class="toggleacl btn btn-sm btn-outline-primary" data-roleid="curator" data-userid="{{userobj.uid}}">
                            <span class="">make curator </span>
                            <i class="far fa-square"></i>
                        </a>
                    {% endif %}

                    {% endif %}
                </div>
            </li>

            {% if userobj.uid == dataset.owner or userobj.uid|string in dataset.dsmetadata.acl %}
                <li>
                    {% set task = dataset.gettask(dbsession, userobj) %}
                    {{ macros.render_progress(task, addclass="singleprocess") }}
                </li>
            {% endif %}
        {% endfor %}
        </ul>
    </div>

{% else %}
    {% if not can_import %}
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                Please upload and format data first.
            </div>
        </div>
    </div>
    {% endif %}
{% endif %}

<div class="row seprow">
    <h4 class="col-12">Delete Dataset</h4>
</div>
<div class="row seprow">
    <div class="col-12">
    <form method="post" id="form_delete_dataset" enctype="multipart/form-data" class="col-12">
        <div class="input-group col-12">
            <input type="hidden" name="action" value="delete_dataset" />
            <input type="hidden" name="confirmation" id="confirmation" value="delete_dataset_unconfirmed" />
            <button class="btn btn-danger" id="form_delete_dataset_confirm">
                <i class="fas fa-trash"></i>&nbsp;OK
            </button>
        </div>
    </form>
    </div>
</div>

{% endblock %}

{% block addscript %}
<script>
    $(document).ready(function() {

        function updateTags(tag_action, newtags) {
            newtags = newtags || [];

            console.log("setting new tags", newtags);
            
            $("#tag_editor").css("opacity", "0.5");
            $("#tag_editor").find(".ajax-loading").show();

            jQuery.ajax({
                url: window.location.href,
                data: JSON.stringify({"action": "tageditor", "tagaction": tag_action || "update_taglist", "newtags": newtags}),
                cache: false,
                contentType: "application/json",
                method: 'POST',
                success: function(data){
                    document.getElementById("tag_editor_container").innerHTML = data;
                    initializeTagEditor();
                },
                error: function(jqXHR, textstatus, err) {
                    if (!err) { return; }
                    alert(textstatus + " " + err);
                }
            });
        }
        
        function updateTagMetadata(tag_action, current_tag, tag_value) {
            console.log("updating tag metadata", tag_action, current_tag, tag_value);
            
            $("#tag_editor").css("opacity", "0.5");
            $("#tag_editor").find(".ajax-loading").show();

            jQuery.ajax({
                url: window.location.href,
                data: JSON.stringify({"action": "tageditor", "tagaction": tag_action, "tag": current_tag, "value": tag_value}),
                cache: false,
                contentType: "application/json",
                method: 'POST',
                success: function(data){
                    document.getElementById("tag_editor_container").innerHTML = data;
                    initializeTagEditor();
                },
                error: function(jqXHR, textstatus, err) {
                    if (!err) { return; }
                    alert(textstatus + " " + err);
                }
            });
        }


        function getCurrentTags() {
            const all_tags = [];

            $("div.tageditor_entry").each((idx, elem) => {
                const $elem = $(elem);
                const cur_tag = $elem.data("tag").trim();
                const cur_position = $elem.data("position");
                const total_tag_count = $elem.data("tagcount");
                all_tags.push( $elem.find("input.tageditor_taginput")[0].value );
            });

            return all_tags;
        }

        function initializeTagEditor() {
            $("div.tageditor_entry").each((idx, elem) => {
                const $elem = $(elem);
                const cur_tag = $elem.data("tag");
                const cur_position = $elem.data("position");
                const total_tag_count = $elem.data("tagcount");
                console.log("TAGEDITOR", idx, elem, cur_tag, cur_position, total_tag_count);
                
                // enable change action if tag has been renamed
                $elem.find("input.tageditor_taginput").on("input change", function handleTagEditorChange() {
                    const $changed_input = $(this);
                    const $entry = $($changed_input.parents("div.tageditor_entry")[0]);
                    
                    const entry_tag = $entry.data("tag").trim();
                    const input_tag = $changed_input.val().trim();

                    // enable action button if a rename was detected
                    let has_change = false;
                    if (entry_tag !== input_tag && input_tag.length > 0) {
                        $entry.find("button.tageditor_action_rename").removeAttr("disabled");
                        has_change = true;
                    } else {
                        $entry.find("button.tageditor_action_rename").attr("disabled", "disabled");
                    }

                    // disable changing other tag names while this one has not been applied
                    // (this prevents the user from simultaneously changing multiple tags)
                    document.querySelectorAll("input.tageditor_taginput").forEach( (other_input) => {
                        if (has_change) {
                            if (other_input === $changed_input[0]) { return; }

                            other_input.disabled = true;
                        } else {
                            other_input.disabled = false;
                        }
                    }); 

                    console.log("CHANGE", entry_tag, "=>", input_tag);

                });

                $elem.find(".tageditor_action").click((e) => {
                    e.preventDefault();
                    if (!e.target) { return false; }

                    let btn = $(e.target)[0];
                    if (btn.tagName.toLowerCase() !== 'button') {
                        btn = $(btn).parents(".tageditor_action")[0];
                    }
                    const $btn = $(btn);
                    const $entry = $btn.parents("div.tageditor_entry")[0];
                    
                    const tag_action = $btn.data("action");
                    const tag_value = $btn.data("value") || null;
                    const current_tag = $btn.data("tag");

                    const initial_tags = getCurrentTags();
                    let updated_tags = [...initial_tags];

                    const tag_index = updated_tags.indexOf(current_tag);
                    let is_metadata_action = false;
                    
                    console.log("tags action", tag_action);
                    if (tag_action === "move_tag_down" && (tag_index < total_tag_count)) {    
                        updated_tags[tag_index] = initial_tags[tag_index + 1];
                        updated_tags[tag_index + 1] = initial_tags[tag_index];
                    } else if (tag_action === "move_tag_up" && (tag_index > 0)) {    
                        updated_tags[tag_index] = initial_tags[tag_index - 1];
                        updated_tags[tag_index - 1] = initial_tags[tag_index];
                    } else if (tag_action === "delete_tag" && updated_tags.indexOf(current_tag) > -1) {
                        updated_tags.splice(updated_tags.indexOf(current_tag), 1);
                    } else if (tag_action === "rename_tag") {
                        // rename is automatically applied in getCurrentTags()
                    } else {
                        is_metadata_action = true;
                    }

                    if (!is_metadata_action) {
                        console.log("TAGACTION", tag_action, initial_tags, "=>", updated_tags);
                        updateTags(tag_action, updated_tags);
                        return false;
                    } else {
                        updateTagMetadata(tag_action, current_tag, tag_value);
                        return true; // required to close the dropdowns
                    }
                });

            });

            const createTagInput = $("input#tageditor_add_tag");
            const createTagButton = $("button#tageditor_add_tag_action");

            createTagInput.on("input change", function handleTagEditorNewTagChange() {
                const current_tags = getCurrentTags();
                const new_tag_value = createTagInput.val().trim();

                if (new_tag_value.length && current_tags.indexOf(new_tag_value) === -1) {
                    createTagButton.removeAttr("disabled");
                } else {
                    createTagButton.attr("disabled", "disabled");
                }
            });
            createTagButton.on("click", function createNewTag(e) {
                e.preventDefault();
                const new_tag_value = createTagInput.val().trim();

                const current_tags = getCurrentTags();
                current_tags.push(new_tag_value);

                updateTags("update_taglist", current_tags);
                return false;
            });
            
            console.log("initializeTagEditor(), current:", getCurrentTags());

        }

        initializeTagEditor();

        let $tbl = $("#previewdftable");
        if ($tbl) {
            $("#previewdftable tbody tr").each(function() {
                $(this).find("td").wrapInner('<div class="tdwrap">');
            });
        }

        document.getElementById("form_delete_dataset_confirm").addEventListener("click", function(e) {
            e.preventDefault();
            if (window.confirm("Warning: You are about to delete a dataset.\nAre you sure?")) {
            if (window.confirm("Are you really sure?\nDeleting a dataset cannot be undone.")) {
                $("input#confirmation").attr("value", "delete_dataset_confirmed");
                return $('#form_delete_dataset').submit();
            }
            }
            return false;
        });

        function setACLstatus($elem, elemrole, newrole) {
            // remove icons
            let $icocheck = $elem.find(".fa-check-square");
            if ($icocheck && $icocheck.length) {
                $icocheck.remove();
            }
            let $icosquare = $elem.find(".fa-square");
            if ($icosquare && $icosquare.length) {
                $icosquare.remove();
            }

            if (!newrole || elemrole !== newrole) {
                $elem.addClass("btn-outline-primary");
                $elem.removeClass("btn-outline-success");
                $newi = $('<i class="far fa-square"></i>');
                $elem.text("make " + elemrole + " ");
                $elem.append($newi);
            } else {
                $elem.removeClass("btn-outline-primary");
                $elem.addClass("btn-outline-success");
                $newi = $('<i class="far fa-check-square"></i>');
                $elem.text(elemrole + " ");
                $elem.append($newi);
            }
        }

        function updateACL(foruser, annoaction, newrole) {
            $("a.toggleacl").each(function(idx, elem) {
                const $elem = $(elem);
                if ($elem.data("userid") != foruser) { return; }
                const elemrole = $elem.data("roleid");

                setACLstatus($elem, elemrole, newrole);

                console.log("updateACL", elem, "elemrole", elemrole, "newrole", newrole);
                if (annoaction === "add_role") {
                    if (elemrole === 'curator') {
                        if (newrole === 'curator') {
                            console.log("elemrole", elemrole, "show");
                            $elem.show();
                        }
                    }
                    if (elemrole === 'annotator') {
                        if (newrole === 'annotator') {
                            console.log("elemrole", elemrole, "show");
                            $elem.show();
                        }
                    }
                }
            });
        }

        $("a.toggleacl").click(function(e) {
            e.preventDefault();
            let $tgt = $(this);

            let $icosquare = $tgt.find(".fa-square");
            let $icocheck = $tgt.find(".fa-check-square");
            
            let annoaction = null;
            let annouser = $tgt.data("userid");
            let annorole = $tgt.data("roleid");
            let $newi = null;

            if ($icosquare && $icosquare.length) {
                annoaction = "add_role";
                $icosquare.remove();
                $newi = $('<i class="far fa-check-square"></i>');
                $tgt.text(annorole + " ");
            }

            if ($icocheck && $icocheck.length) {
                annoaction = "rem_role";
                $icocheck.remove();
                $newi = $('<i class="far fa-square"></i>');
                $tgt.text("make " + annorole + " ");
            }

            $.ajax({
                type: "POST",
                url: $(location).attr("href"),
                data: {"action": annoaction, "annouser": annouser, "annorole": annorole},
                dataType: "json",
                success: function() {
                    $tgt.toggleClass("btn-outline-primary");
                    $tgt.toggleClass("btn-outline-success");
                    $tgt.append($newi);
                    
                    if (annoaction == "add_role") {
                        updateACL(annouser, annoaction, annorole);
                    } else {
                        updateACL(annouser, annoaction, null);
                    }
                },
                error: function(jqXHR, textstatus, err) {
                    if (!err) { return; }
                    alert(textstatus + " " + err);
                }
            });

            return false;
        });
    });

</script>
{% endblock %}
