{% extends "layout.html" %}
{% block body %}
<div class="row">
<h1 class="col-12">Annotate &quot;<span class="annometa">{{ task.name }}</span>&quot; 
    {% if dataset.get_description() != "" %}<button class="btn btn-light btn-ds-description" data-toggle="modal" data-target="#dsDescriptionModal">
        <i class="fas fa-info"></i> info
    </button>{% endif %}
</h1>
</div>

{{ render_progress(task, addclass="annoprogress") }}

<div class="row">
<div id="anno_actions">
    {% if dataset.dsmetadata.size > 0 and sample_idx > 0 %}
    <a id="anno_nav_prev"class="btn btn-info btn-lg" href="{{ url_for('annotate', dsid=dataset.dataset_id, sample_idx=sample_idx - 1) }}" title="previous sample">
        <i class="fas fa-2x fa-arrow-left"></i>
    </a>
{% endif %}
    {% if dataset.dsmetadata.size > 0 and sample_idx == 0 %}
    <a id="anno_nav_prev" class="btn btn-info btn-lg" href="{{ url_for('annotate', dsid=dataset.dataset_id, sample_idx=dataset.dsmetadata.size - 1) }}" title="previous sample">
        <i class="fas fa-2x fa-arrow-left"></i>
    </a>
{% endif %}

{% set nextsampleidx = sample_idx + 1 %}
{% if not next_sample_idx is none %}
{% set nextsampleidx = next_sample_idx %}
{% endif %}

{% for tag,tagmetadata in dataset.get_taglist(include_metadata=True).items() %}
{% if dataset.dsmetadata.size > 0 and sample_idx < (dataset.dsmetadata.size - 1) %}
<a data-tagidx="{{loop.index - 1}}" class="btn {% if tag != curanno %}btn-light{% else %}btn-success{% endif %}{% if votes and tag in votes and votes[tag]|length %} with_anno_vote{% endif %} {% if tagmetadata.color %} tagcolor_{{ tagmetadata.color }}{% endif %}" href="{{ url_for('annotate', dsid=dataset.dataset_id, sample_idx=nextsampleidx, set_sample_idx=sample_idx, set_value=tag) }}" {% if votes and tag in votes and votes[tag]|length %}title="{{votes[tag]|length}} vote(s) by {{votes[tag]|join(", ")}}"{% endif %}>
{% endif %}
{% if dataset.dsmetadata.size > 0 and sample_idx == (dataset.dsmetadata.size - 1) %}
<a data-tagidx="{{loop.index - 1}}" class="btn {% if tag != curanno %}btn-light{% else %}btn-success{% endif %}{% if votes and tag in votes and votes[tag]|length %} with_anno_vote{% endif %} {% if tagmetadata.color %} tagcolor_{{ tagmetadata.color }}{% endif %}" href="{{ url_for('annotate', dsid=dataset.dataset_id, sample_idx=0, set_sample_idx=sample_idx, set_value=tag) }}" {% if votes and tag in votes and votes[tag]|length %}title="{{votes[tag]|length}} vote(s) by {{votes[tag]|join(", ")}}"{% endif %}>
{% endif %}
{% if tagmetadata.icon %}<i class="{{ tagmetadata.icon }}"> </i>{% endif %}
{{ tag }} {% if votes and tag in votes and votes[tag]|length %}<span class="anno_vote badge badge-dark">{{votes[tag]|length}}</span>{% endif %}
</a>
{% else %}
ERROR: no tags defined
{% endfor %}

{% if dataset.dsmetadata.size > 0 and sample_idx < (dataset.dsmetadata.size - 1) %}
<a id="anno_nav_next" class="btn btn-info btn-lg" href="{{ url_for('annotate', dsid=dataset.dataset_id, sample_idx=nextsampleidx) }}" title="next sample">
    <i class="fas fa-2x fa-arrow-right"></i>
</a>
{% endif %}
{% if dataset.dsmetadata.size > 0 and sample_idx == (dataset.dsmetadata.size - 1) %}
<a id="anno_nav_next" class="btn btn-info btn-lg" href="{{ url_for('annotate', dsid=dataset.dataset_id, sample_idx=0) }}" title="next sample">
    <i class="fas fa-2x fa-arrow-right"></i>
</a>
{% endif %}

<a id="anno_nav_random" class="btn btn-info btn-lg" href="{{ url_for('annotate', dsid=dataset.dataset_id, sample_idx=random_sample) }}" title="random sample">
    <i class="fas fa-2x fa-random"></i>
</a>

</div>
</div>

<br />
<div class="row">
<blockquote class="sampletext col-12 col-md-10 offset-md-1">
    {{sample_content}}
</blockquote>
</div>

<br />
<br />

{{ render_description_modal("dsDescriptionModal", dataset.get_description()) }}

{% endblock %}

{% block addscript %}
    <script>
        $(document).ready(function() {

            document.addEventListener("keydown", event => {
                if (event.isComposing || event.keyCode === 229) {
                    return;
                }
                console.log("kbd", event);
                let $tgtid = null;

                if (event.key === "ArrowRight") {
                    $tgtid = 'anno_nav_next';
                }
                if (event.key === "ArrowLeft") {
                    $tgtid = 'anno_nav_prev';
                }
                if (event.key === "R" || event.key === "r") {
                    $tgtid = 'anno_nav_random';
                }
                let $tgtbtn = null;
                if ($tgtid) {
                    $tgtbtn = $("#" + $tgtid);
                }
                if (event.keyCode > 48 && event.keyCode <= 57) {
                    let tagoffset = event.keyCode - 48 - 1;
                    let tagcount = {{ dataset.get_taglist()|length }};
                    if (tagoffset < tagcount) {
                        $("a.btn").each(function() {
                            let $this = $(this);
                            if ($this.data("tagidx") == tagoffset) {
                                $tgtbtn = $(this);
                            }
                        });
                    }
                }
                if ($tgtbtn && $tgtbtn[0]) { 
                    $($tgtbtn[0]).removeClass("btn-info");
                    $($tgtbtn[0]).removeClass("btn-primary");
                    $($tgtbtn[0]).removeClass("btn-success");
                    $($tgtbtn[0]).removeClass("btn-light");
                    $($tgtbtn[0]).addClass("btn-dark");
                    $tgtbtn[0].click();
                }
            });

        });
    </script>
{% endblock %}
